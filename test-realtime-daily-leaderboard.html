<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®æ—¶æ¯æ—¥æŒ‘æˆ˜æ’è¡Œæ¦œæµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            margin: 0 0 10px 0;
            font-size: 2em;
        }

        .header p {
            margin: 0;
            opacity: 0.9;
        }

        .content {
            padding: 20px;
        }

        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #f9f9f9;
        }

        .test-section h3 {
            margin-top: 0;
            color: #333;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #2196f3;
            color: white;
        }

        .btn-primary:hover {
            background: #1976d2;
        }

        .btn-success {
            background: #4caf50;
            color: white;
        }

        .btn-success:hover {
            background: #45a049;
        }

        .btn-warning {
            background: #ff9800;
            color: white;
        }

        .btn-warning:hover {
            background: #f57c00;
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn-danger:hover {
            background: #d32f2f;
        }

        .status {
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-weight: 500;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .log {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }

        .leaderboard-container {
            margin-top: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #2196f3;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
        }

        .realtime-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .realtime-indicator.active {
            background: #4caf50;
            animation: pulse 2s infinite;
        }

        .realtime-indicator.inactive {
            background: #f44336;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ† å®æ—¶æ¯æ—¥æŒ‘æˆ˜æ’è¡Œæ¦œæµ‹è¯•</h1>
            <p>æµ‹è¯•å®æ—¶æ’è¡Œæ¦œåŠŸèƒ½ï¼ŒåŒ…æ‹¬æ•°æ®æäº¤ã€å®æ—¶æ›´æ–°å’Œç”¨æˆ·ç»Ÿè®¡</p>
        </div>

        <div class="content">
            <!-- çŠ¶æ€æ˜¾ç¤º -->
            <div id="status" class="status info">
                <span class="realtime-indicator inactive"></span>
                å‡†å¤‡å°±ç»ª - ç‚¹å‡»"å¼€å§‹æµ‹è¯•"å¼€å§‹æ¼”ç¤º
            </div>

            <!-- æ§åˆ¶æŒ‰é’® -->
            <div class="test-section">
                <h3>ğŸ® æµ‹è¯•æ§åˆ¶</h3>
                <div class="button-group">
                    <button id="startTest" class="btn btn-primary">å¼€å§‹æµ‹è¯•</button>
                    <button id="submitChallenge" class="btn btn-success" disabled>æäº¤æŒ‘æˆ˜è®°å½•</button>
                    <button id="refreshLeaderboard" class="btn btn-warning" disabled>åˆ·æ–°æ’è¡Œæ¦œ</button>
                    <button id="startRealtime" class="btn btn-success" disabled>å¯åŠ¨å®æ—¶æ›´æ–°</button>
                    <button id="stopRealtime" class="btn btn-danger" disabled>åœæ­¢å®æ—¶æ›´æ–°</button>
                    <button id="clearLog" class="btn btn-warning">æ¸…ç©ºæ—¥å¿—</button>
                </div>
            </div>

            <!-- ç”¨æˆ·ç»Ÿè®¡ -->
            <div class="test-section">
                <h3>ğŸ“Š ç”¨æˆ·ç»Ÿè®¡</h3>
                <div class="stats-grid" id="userStats">
                    <div class="stat-card">
                        <div class="stat-value" id="totalChallenges">0</div>
                        <div class="stat-label">æ€»æŒ‘æˆ˜æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="averageScore">0</div>
                        <div class="stat-label">å¹³å‡åˆ†æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card">
                            <div class="stat-value" id="bestScore">0</div>
                            <div class="stat-label">æœ€ä½³åˆ†æ•°</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="consecutiveDays">0</div>
                        <div class="stat-label">è¿ç»­å¤©æ•°</div>
                    </div>
                </div>
            </div>

            <!-- æ’è¡Œæ¦œæ˜¾ç¤º -->
            <div class="test-section">
                <h3>ğŸ† å®æ—¶æ’è¡Œæ¦œ</h3>
                <div id="leaderboardContainer" class="leaderboard-container">
                    <p>æ’è¡Œæ¦œå°†åœ¨è¿™é‡Œæ˜¾ç¤º...</p>
                </div>
            </div>

            <!-- æ—¥å¿—æ˜¾ç¤º -->
            <div class="test-section">
                <h3>ğŸ“ æ“ä½œæ—¥å¿—</h3>
                <div id="log" class="log">ç­‰å¾…æ“ä½œ...</div>
            </div>
        </div>
    </div>

    <script type="module">
        // æ¨¡æ‹Ÿå®æ—¶æ¯æ—¥æŒ‘æˆ˜æœåŠ¡
        class MockRealtimeDailyChallengeService {
            constructor() {
                this.leaderboard = [];
                this.userStats = {
                    totalChallenges: 0,
                    averageScore: 0,
                    bestScore: 0,
                    consecutiveDays: 0,
                    completionRate: 0
                };
                this.realtimeInterval = null;
                this.isRealtimeActive = false;
            }

            async submitDailyChallengeCompletion(challengeData) {
                this.log(`ğŸš€ æäº¤æ¯æ—¥æŒ‘æˆ˜å®Œæˆè®°å½•:`, challengeData);
                
                // æ¨¡æ‹ŸAPIå»¶è¿Ÿ
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // ç”Ÿæˆæ¨¡æ‹Ÿæ•°æ®
                const newEntry = {
                    id: `mock_${Date.now()}`,
                    playerName: challengeData.playerName || 'æµ‹è¯•ç©å®¶',
                    date: challengeData.date,
                    puzzleName: challengeData.puzzleName,
                    difficulty: challengeData.difficulty,
                    pieceShape: challengeData.pieceShape,
                    gridSize: challengeData.gridSize,
                    completionTime: challengeData.completionTime,
                    moves: challengeData.moves,
                    score: challengeData.score,
                    isPerfect: challengeData.isPerfect,
                    totalStars: challengeData.totalStars,
                    consecutiveDays: challengeData.consecutiveDays,
                    completedAt: new Date(),
                    rank: this.leaderboard.length + 1
                };

                // æ·»åŠ åˆ°æ’è¡Œæ¦œ
                this.leaderboard.push(newEntry);
                
                // é‡æ–°æ’åº
                this.leaderboard.sort((a, b) => {
                    if (b.score !== a.score) return b.score - a.score;
                    return a.completionTime - b.completionTime;
                });

                // æ›´æ–°æ’å
                this.leaderboard.forEach((entry, index) => {
                    entry.rank = index + 1;
                });

                // æ›´æ–°ç”¨æˆ·ç»Ÿè®¡
                this.updateUserStats();

                this.log(`âœ… æŒ‘æˆ˜è®°å½•æäº¤æˆåŠŸï¼Œå½“å‰æ’å: #${newEntry.rank}`);
                
                return {
                    gameId: newEntry.id,
                    score: challengeData.score,
                    rewards: {
                        coins: challengeData.isPerfect ? 100 : 50,
                        experience: challengeData.isPerfect ? 50 : 25
                    },
                    isNewRecord: true,
                    rank: newEntry.rank,
                    leaderboardUpdated: true
                };
            }

            async getRealtimeDailyChallengeLeaderboard(date, limit = 50, forceRefresh = false) {
                this.log(`ğŸŒ è·å–å®æ—¶æ’è¡Œæ¦œæ•°æ® (å¼ºåˆ¶åˆ·æ–°: ${forceRefresh})`);
                
                // æ¨¡æ‹ŸAPIå»¶è¿Ÿ
                await new Promise(resolve => setTimeout(resolve, 500));
                
                const filteredLeaderboard = this.leaderboard
                    .filter(entry => !date || entry.date === date)
                    .slice(0, limit);

                return {
                    leaderboard: filteredLeaderboard,
                    userRank: this.getUserRank(),
                    lastUpdated: new Date().toISOString(),
                    isRealtime: this.isRealtimeActive
                };
            }

            async getUserDailyChallengeStats() {
                this.log(`ğŸ“Š è·å–ç”¨æˆ·ç»Ÿè®¡ä¿¡æ¯`);
                return { ...this.userStats };
            }

            startRealtimeUpdates(callback, interval = 10000, date, limit) {
                this.log(`ğŸ”„ å¯åŠ¨å®æ—¶æ›´æ–°ï¼Œé—´éš”: ${interval}ms`);
                this.isRealtimeActive = true;
                
                this.realtimeInterval = setInterval(async () => {
                    try {
                        const data = await this.getRealtimeDailyChallengeLeaderboard(date, limit, true);
                        callback(data);
                        this.log(`ğŸ”„ å®æ—¶æ›´æ–°å®Œæˆï¼Œæ•°æ®æ¡æ•°: ${data.leaderboard.length}`);
                    } catch (error) {
                        this.log(`âŒ å®æ—¶æ›´æ–°å¤±è´¥: ${error.message}`);
                    }
                }, interval);

                return () => {
                    this.log(`â¹ï¸ åœæ­¢å®æ—¶æ›´æ–°`);
                    this.isRealtimeActive = false;
                    if (this.realtimeInterval) {
                        clearInterval(this.realtimeInterval);
                        this.realtimeInterval = null;
                    }
                };
            }

            updateUserStats() {
                if (this.leaderboard.length === 0) return;

                const scores = this.leaderboard.map(entry => entry.score);
                this.userStats.totalChallenges = this.leaderboard.length;
                this.userStats.averageScore = Math.round(scores.reduce((sum, score) => sum + score, 0) / scores.length);
                this.userStats.bestScore = Math.max(...scores);
                this.userStats.consecutiveDays = this.calculateConsecutiveDays();
                this.userStats.completionRate = 100;
            }

            calculateConsecutiveDays() {
                const dates = [...new Set(this.leaderboard.map(entry => entry.date))].sort();
                let consecutive = 1;
                
                for (let i = 1; i < dates.length; i++) {
                    const prevDate = new Date(dates[i - 1]);
                    const currDate = new Date(dates[i]);
                    const diffDays = Math.floor((currDate - prevDate) / (1000 * 60 * 60 * 24));
                    
                    if (diffDays === 1) {
                        consecutive++;
                    } else {
                        break;
                    }
                }
                
                return consecutive;
            }

            getUserRank() {
                // æ¨¡æ‹Ÿç”¨æˆ·æ’åè®¡ç®—
                return this.leaderboard.length > 0 ? Math.floor(Math.random() * this.leaderboard.length) + 1 : null;
            }

            log(message, data = null) {
                const timestamp = new Date().toLocaleTimeString();
                const logElement = document.getElementById('log');
                const logMessage = `[${timestamp}] ${message}${data ? '\n' + JSON.stringify(data, null, 2) : ''}`;
                logElement.textContent += logMessage + '\n';
                logElement.scrollTop = logElement.scrollHeight;
            }
        }

        // åˆå§‹åŒ–æœåŠ¡
        const service = new MockRealtimeDailyChallengeService();
        let stopRealtimeUpdates = null;

        // DOMå…ƒç´ 
        const statusElement = document.getElementById('status');
        const userStatsElements = {
            totalChallenges: document.getElementById('totalChallenges'),
            averageScore: document.getElementById('averageScore'),
            bestScore: document.getElementById('bestScore'),
            consecutiveDays: document.getElementById('consecutiveDays')
        };
        const leaderboardContainer = document.getElementById('leaderboardContainer');

        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        function updateStatus(message, type = 'info') {
            statusElement.textContent = message;
            statusElement.className = `status ${type}`;
        }

        // æ›´æ–°ç”¨æˆ·ç»Ÿè®¡æ˜¾ç¤º
        function updateUserStatsDisplay(stats) {
            userStatsElements.totalChallenges.textContent = stats.totalChallenges;
            userStatsElements.averageScore.textContent = stats.averageScore;
            userStatsElements.bestScore.textContent = stats.bestScore;
            userStatsElements.consecutiveDays.textContent = stats.consecutiveDays;
        }

        // æ›´æ–°æ’è¡Œæ¦œæ˜¾ç¤º
        function updateLeaderboardDisplay(leaderboard) {
            if (leaderboard.length === 0) {
                leaderboardContainer.innerHTML = '<p>ğŸ“­ æš‚æ— æ’è¡Œæ¦œæ•°æ®</p>';
                return;
            }

            const html = `
                <div style="max-height: 400px; overflow-y: auto;">
                    ${leaderboard.map((entry, index) => `
                        <div style="display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #eee; background: ${index % 2 === 0 ? '#f9f9f9' : 'white'};">
                            <div style="width: 50px; text-align: center; font-weight: bold; color: ${entry.rank <= 3 ? '#ff9800' : '#666'};">
                                #${entry.rank}
                            </div>
                            <div style="flex: 1; margin-left: 15px;">
                                <div style="font-weight: 600;">${entry.playerName}</div>
                                <div style="font-size: 0.9em; color: #666;">${entry.puzzleName} â€¢ ${entry.difficulty}</div>
                            </div>
                            <div style="width: 80px; text-align: center;">
                                <div style="font-weight: bold; color: #2196f3;">${entry.score}</div>
                                <div style="font-size: 0.8em; color: #666;">åˆ†æ•°</div>
                            </div>
                            <div style="width: 80px; text-align: center;">
                                <div style="font-weight: bold;">${Math.floor(entry.completionTime / 60)}:${(entry.completionTime % 60).toString().padStart(2, '0')}</div>
                                <div style="font-size: 0.8em; color: #666;">æ—¶é—´</div>
                            </div>
                            <div style="width: 60px; text-align: center;">
                                <div style="font-weight: bold;">${entry.moves}</div>
                                <div style="font-size: 0.8em; color: #666;">æ­¥æ•°</div>
                            </div>
                            <div style="width: 100px; text-align: right;">
                                ${entry.isPerfect ? '<span style="background: #ff9800; color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.8em;">â­ å®Œç¾</span>' : ''}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            leaderboardContainer.innerHTML = html;
        }

        // ç”Ÿæˆæ¨¡æ‹ŸæŒ‘æˆ˜æ•°æ®
        function generateMockChallengeData() {
            const difficulties = ['ç®€å•', 'ä¸­ç­‰', 'å›°éš¾'];
            const pieceShapes = ['æ­£æ–¹å½¢', 'ä¸‰è§’å½¢', 'å…­è¾¹å½¢'];
            const puzzleNames = ['æ¯æ—¥æŒ‘æˆ˜-æ‹¼å›¾å¤§å¸ˆ', 'æ¯æ—¥æŒ‘æˆ˜-é€Ÿåº¦æŒ‘æˆ˜', 'æ¯æ—¥æŒ‘æˆ˜-å®Œç¾ä¸»ä¹‰'];
            
            return {
                date: new Date().toISOString().split('T')[0],
                challengeId: `challenge_${Date.now()}`,
                puzzleName: puzzleNames[Math.floor(Math.random() * puzzleNames.length)],
                difficulty: difficulties[Math.floor(Math.random() * difficulties.length)],
                pieceShape: pieceShapes[Math.floor(Math.random() * pieceShapes.length)],
                gridSize: '8x8',
                totalPieces: 64,
                completionTime: Math.floor(Math.random() * 300) + 60, // 1-6åˆ†é’Ÿ
                moves: Math.floor(Math.random() * 50) + 20, // 20-70æ­¥
                score: Math.floor(Math.random() * 500) + 500, // 500-1000åˆ†
                isPerfect: Math.random() > 0.7, // 30%æ¦‚ç‡å®Œç¾
                totalStars: Math.floor(Math.random() * 5) + 1,
                consecutiveDays: Math.floor(Math.random() * 10) + 1,
                playerName: `ç©å®¶${Math.floor(Math.random() * 1000)}`
            };
        }

        // äº‹ä»¶ç›‘å¬å™¨
        document.getElementById('startTest').addEventListener('click', async () => {
            updateStatus('ğŸ”„ å¼€å§‹æµ‹è¯•...', 'info');
            
            // å¯ç”¨æŒ‰é’®
            document.getElementById('submitChallenge').disabled = false;
            document.getElementById('refreshLeaderboard').disabled = false;
            document.getElementById('startRealtime').disabled = false;
            
            // åŠ è½½åˆå§‹æ•°æ®
            try {
                const leaderboardData = await service.getRealtimeDailyChallengeLeaderboard();
                updateLeaderboardDisplay(leaderboardData.leaderboard);
                
                const userStats = await service.getUserDailyChallengeStats();
                updateUserStatsDisplay(userStats);
                
                updateStatus('âœ… æµ‹è¯•ç¯å¢ƒå‡†å¤‡å°±ç»ª', 'success');
            } catch (error) {
                updateStatus(`âŒ åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
            }
        });

        document.getElementById('submitChallenge').addEventListener('click', async () => {
            updateStatus('ğŸš€ æäº¤æŒ‘æˆ˜è®°å½•...', 'info');
            
            try {
                const challengeData = generateMockChallengeData();
                const result = await service.submitDailyChallengeCompletion(challengeData);
                
                // æ›´æ–°æ˜¾ç¤º
                const leaderboardData = await service.getRealtimeDailyChallengeLeaderboard();
                updateLeaderboardDisplay(leaderboardData.leaderboard);
                
                const userStats = await service.getUserDailyChallengeStats();
                updateUserStatsDisplay(userStats);
                
                updateStatus(`âœ… æŒ‘æˆ˜è®°å½•æäº¤æˆåŠŸï¼æ’å: #${result.rank}`, 'success');
            } catch (error) {
                updateStatus(`âŒ æäº¤å¤±è´¥: ${error.message}`, 'error');
            }
        });

        document.getElementById('refreshLeaderboard').addEventListener('click', async () => {
            updateStatus('ğŸ”„ åˆ·æ–°æ’è¡Œæ¦œ...', 'info');
            
            try {
                const leaderboardData = await service.getRealtimeDailyChallengeLeaderboard(null, 50, true);
                updateLeaderboardDisplay(leaderboardData.leaderboard);
                
                updateStatus(`âœ… æ’è¡Œæ¦œå·²åˆ·æ–°ï¼Œå…± ${leaderboardData.leaderboard.length} æ¡è®°å½•`, 'success');
            } catch (error) {
                updateStatus(`âŒ åˆ·æ–°å¤±è´¥: ${error.message}`, 'error');
            }
        });

        document.getElementById('startRealtime').addEventListener('click', () => {
            updateStatus('ğŸ”„ å¯åŠ¨å®æ—¶æ›´æ–°...', 'info');
            
            stopRealtimeUpdates = service.startRealtimeUpdates((data) => {
                updateLeaderboardDisplay(data.leaderboard);
                updateStatus(`ğŸŸ¢ å®æ—¶æ›´æ–°ä¸­... æ•°æ®æ¡æ•°: ${data.leaderboard.length}`, 'success');
            }, 3000); // 3ç§’æ›´æ–°ä¸€æ¬¡
            
            document.getElementById('startRealtime').disabled = true;
            document.getElementById('stopRealtime').disabled = false;
        });

        document.getElementById('stopRealtime').addEventListener('click', () => {
            if (stopRealtimeUpdates) {
                stopRealtimeUpdates();
                stopRealtimeUpdates = null;
            }
            
            updateStatus('â¹ï¸ å®æ—¶æ›´æ–°å·²åœæ­¢', 'info');
            document.getElementById('startRealtime').disabled = false;
            document.getElementById('stopRealtime').disabled = true;
        });

        document.getElementById('clearLog').addEventListener('click', () => {
            document.getElementById('log').textContent = 'æ—¥å¿—å·²æ¸…ç©º...\n';
        });

        // åˆå§‹åŒ–
        updateStatus('å‡†å¤‡å°±ç»ª - ç‚¹å‡»"å¼€å§‹æµ‹è¯•"å¼€å§‹æ¼”ç¤º', 'info');
    </script>
</body>
</html>
